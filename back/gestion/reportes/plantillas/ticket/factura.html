<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factura</title>
    <style>
        body { font-family: 'Courier New', Courier, monospace; font-size: 10px; margin: 0; padding: 0; color: #000; }
        /* Medida ajustada para impresoras de 58mm */
        .ticket { width: 48mm; padding: 1mm; }
        .header, .afip-footer { text-align: center; }
        .header h1 { margin: 0; font-size: 14px; font-weight: bold; word-wrap: break-word; }
        .header p { margin: 2px 0; }
        .factura-info { display: flex; justify-content: space-between; font-size: 11px; font-weight: bold; }
        hr { border: none; border-top: 1px dashed black; margin: 5px 0; }
        .cliente-info p { margin-bottom: 3px; }
        .item-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
        .item-table th, .item-table td { padding: 2px 0; }
        .col-cant { width: 15%; text-align: left; }
        .col-desc { width: 45%; text-align: left; }
        .col-pu { width: 20%; text-align: right; }
        .col-subt { width: 20%; text-align: right; }
        .item-discount td { font-size: 9px; color: #555; border-top: none; padding-top: 0; }
        .totals-section { margin-top: 8px; border-top: 1px dashed black; padding-top: 5px; }
        .totals-section .item { display: flex; justify-content: space-between; font-weight: bold; }
        .totals-section .discount { color: #555; }
        .total-final { font-size: 13px; }
        .membrete-section {
            text-align: center;
            font-size: 9px;
            padding: 4px 0;
            border-top: 1px dashed black;
            border-bottom: 1px dashed black;
            margin: 5px 0;
        }
        .observaciones-finales-section {
            margin-top: 8px;
            font-size: 9px;
            word-wrap: break-word;
            margin-bottom: 5px; 
        }
        .afip-footer { margin-top: 10px; }
        .afip-footer p { margin: 1px 0; font-weight: bold; }
        .afip-footer img { max-width: 100px; height: auto; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="ticket">
        <div class="header">
            <h1>{{ emisor.razon_social }}</h1>
            <p>{{ emisor.domicilio }}</p>
            <p>CUIT: {{ emisor.cuit }}</p>
            <p>IVA: {{ emisor.condicion_iva }}</p>
            <hr>
            <div class="factura-info">
                <span>FACTURA</span>
                <span>{{ afip.tipo_comprobante_letra or 'B' }}</span> 
            </div>
            <p>P.Venta: {{ '%05d'|format(emisor.punto_venta) }} - N°: {{ '%08d'|format(afip.numero_comprobante or 0) }}</p>
            <p>Fecha: {{ fecha_emision | date }}</p>
            <hr>
        </div>

        <div class="cliente-info">
            <p><strong>Cliente:</strong> {{ receptor.nombre_razon_social or 'Consumidor Final' }}</p>
            <p><strong>CUIT/DNI:</strong> {{ receptor.cuit_o_dni or 'S/D' }}</p>
            <p><strong>IVA:</strong> {{ receptor.condicion_iva or 'Consumidor Final' }}</p>
        </div>
        <hr>
        
        <table class="item-table">
            <thead>
                <tr>
                    <th class="col-cant">Cant</th>
                    <th class="col-desc">Desc</th>
                    <th class="col-pu">P/U</th>
                    <th class="col-subt">Subt</th>
                </tr>
            </thead>
            <tbody>
                {% for item in transaccion.items %}
                <tr>
                    <td class="col-cant">{{ item.cantidad }}</td>
                    <td class="col-desc">{{ item.descripcion }}</td>
                    <td class="col-pu">${{ "%.2f"|format(item.precio_unitario) }}</td>
                    <td class="col-subt">${{ "%.2f"|format(item.cantidad * item.precio_unitario) }}</td>
                </tr>
                {% if item.descuento_especifico and item.descuento_especifico > 0 %}
                <tr class="item-discount">
                    <td></td>
                    <td colspan="2">
                        Desc. {% if item.descuento_especifico_por > 0 %}({{ "%.0f"|format(item.descuento_especifico_por) }}%){% endif %}
                    </td>
                    <td class="col-subt">-${{ "%.2f"|format(item.descuento_especifico) }}</td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>

        <div class="totals-section">
            <div class="item">
                <span>SUBTOTAL</span>
                <span>${{ "%.2f"|format(transaccion.total + (transaccion.descuento_general or 0)) }}</span>
            </div>
            {% if transaccion.descuento_general and transaccion.descuento_general > 0 %}
                <div class="item discount">
                    <span>DESC. GRAL. {% if transaccion.descuento_general_por > 0 %}({{ "%.0f"|format(transaccion.descuento_general_por) }}%){% endif %}</span>
                    <span>-${{ "%.2f"|format(transaccion.descuento_general) }}</span>
                </div>
            {% endif %}
            <div class="item total-final">
                <span>TOTAL</span>
                <span>${{ "%.2f"|format(transaccion.total) }}</span>
            </div>
        </div>

        {% if transaccion.observaciones and '---' in transaccion.observaciones %}
            {% set partes = transaccion.observaciones.split('---', 1) %}
            {% set membrete = partes[0] | trim %}
            {% set notas_venta = partes[1] | trim %}
            
            <div class="membrete-section">
                {{ membrete }}
            </div>
            
            {% set observaciones_para_mostrar = notas_venta %}
        {% else %}
            {% set observaciones_para_mostrar = transaccion.observaciones %}
        {% endif %}
        
        {% if observaciones_para_mostrar %}
            <div class="observaciones-finales-section">
                <pre style="font-family: 'Courier New', Courier, monospace; margin: 0; white-space: pre-wrap; word-wrap: break-word;">{{ observaciones_para_mostrar }}</pre>
            </div>
        {% endif %}
        
        <hr>

        <div class="afip-footer">
            {% if afip and afip.cae %}
                <p>CAE N°: {{ afip.cae }}</p>
                <p>Vto. CAE: {{ afip.vencimiento_cae }}</p>
                {% if qr_base64 %}
                    <img src="data:image/png;base64,{{ qr_base64 }}" alt="Código QR AFIP">
                {% endif %}
                <p>Comprobante Autorizado</p>
            {% endif %}
        </div>
    </div>
</body>
</html>